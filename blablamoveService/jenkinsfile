pipeline {
    agent  { 
        label 'slave-3.23-node-10.15'
    }
    stages {
        stage('Prebuild') {
            steps {
                sh '''
                    cd blablamoveService
                    npm install
                '''
            }
        }
        stage('Build') {
            steps {
                sh '''
                    cd blablamoveService
                    npm run build
                '''
            }
        }
        stage('Test'){
            steps{
                sh '''
                    docker run --rm \
                        --expose 3306 \
                        -e MYSQL_ROOT_PASSWORD=root \
                        -e MYSQL_ROOT_HOST=% \
                        -e MYSQL_DATABASE=blablamove \
                        -e MYSQL_USER=user \
                        -e MYSQL_PASSWORD=user \
                        -d \
                        --name blablamove-test-mysql \
                        lucasmatteo/db_order_soa
                    docker run --rm \
                        --expose 5672\
                        --expose 15672\
                        -d \
                        --name blablamove-test-queue \
                        rabbitmq:3.7
                    docker exec blablamove-test-queue rabbitmq-plugins enable rabbitmq_management
                '''
                timeout(time: 3, unit: 'MINUTES') {
                    sh'''
                        cd blablamoveService
                        ./waitDB.sh blablamove-test-mysql
                        ./waitQ.sh blablamove-test-queue
                    '''
                }
                sh '''
                    export dbName=`docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' blablamove-test-mysql`
                    export qName=`docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' blablamove-test-queue`
                    cd blablamoveService
                    npm run test
                '''
            }
            post{
                always{
                    sh '''
                        docker stop blablamove-test-mysql
                        docker stop blablamove-test-queue
                    '''
                }
            }
        }
        stage('Integration test'){
            steps{
                sh '''
                    docker run --rm \
                        --expose 3306 \
                        -e MYSQL_ROOT_PASSWORD=root \
                        -e MYSQL_ROOT_HOST=% \
                        -e MYSQL_DATABASE=blablamove \
                        -e MYSQL_USER=user \
                        -e MYSQL_PASSWORD=user \
                        -d \
                        --name blablamove-it-mysql \
                        lucasmatteo/db_order_soa
                    docker run --rm \
                        --expose 5672\
                        --expose 15672\
                        -d \
                        --name blablamove-it-queue \
                        rabbitmq:3.7
                '''
                timeout(time: 3, unit: 'MINUTES') {
                    sh'''
                        cd blablamoveService
                        ./waitDB.sh blablamove-it-mysql
                    '''
                }
                sh '''
                    docker exec blablamove-it-queue rabbitmq-plugins enable rabbitmq_management
                '''
                timeout(time: 3, unit: 'MINUTES') {
                    sh'''
                        cd blablamoveService
                        ./waitQ.sh blablamove-it-queue
                    '''
                }
                sh '''
                    export dbName=`docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' blablamove-it-mysql`
                    export qName=`docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' blablamove-it-queue`
                    cd blablamoveService
                    npm run start &
                    npm run it
                '''
            }
            post{
                always{
                    sh '''
                        docker stop blablamove-it-mysql
                        docker stop blablamove-it-queue
                    '''
                }
            }
        }
    }
}